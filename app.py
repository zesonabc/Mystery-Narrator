import streamlit as st
import google.generativeai as genai
import pandas as pd
import json
from PIL import Image

# ================= é¡µé¢é…ç½® =================
st.set_page_config(page_title="MysteryNarrator (Imagen 4)", layout="wide", page_icon="ğŸ§¬")

st.markdown("""
<style>
    .stApp { background-color: #000; color: #fff; }
    .stButton>button { 
        background: linear-gradient(90deg, #FF00CC, #333399); 
        color: white; 
        border: none; 
        font-weight: bold;
    }
</style>
""", unsafe_allow_html=True)

with st.sidebar:
    st.title("ğŸ§¬ æœªæ¥ç‰ˆå¼•æ“")
    api_key = st.text_input("Gemini API Key", type="password")
    st.success("æ£€æµ‹åˆ°ç¯å¢ƒï¼š\nGoogle Internal / Preview Tier")

# ================= æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨é€‚é… =================

def get_first_available_text_model():
    """è‡ªåŠ¨æ‰«æä½ çš„è´¦å·é‡Œåˆ°åº•å“ªä¸ªæ–‡æœ¬æ¨¡å‹èƒ½ç”¨"""
    try:
        # éå†æ‰€æœ‰æ¨¡å‹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåå­—é‡Œå¸¦ gemini ä¸”èƒ½ç”Ÿæˆæ–‡æœ¬çš„
        for m in genai.list_models():
            if 'generateContent' in m.supported_generation_methods:
                if 'gemini' in m.name:
                    return m.name
        return None
    except:
        return None

def analyze_script(script, key):
    genai.configure(api_key=key)
    
    # 1. è‡ªåŠ¨å¯»æ‰¾å¯ç”¨çš„æ–‡æœ¬æ¨¡å‹ (ä¸å†ç¡¬ç¼–ç  1.5-flash)
    model_name = get_first_available_text_model()
    
    if not model_name:
        st.error("âŒ æ— æ³•è‡ªåŠ¨æ‰¾åˆ°å¯ç”¨çš„æ–‡æœ¬æ¨¡å‹ï¼Œè¯·æ£€æŸ¥ Key æƒé™ã€‚")
        return None
        
    st.toast(f"æ­£åœ¨ä½¿ç”¨æ–‡æœ¬æ¨¡å‹: {model_name}...")
    
    model = genai.GenerativeModel(model_name)
    
    prompt = f"""
    Task: Split script into scenes for a mystery video.
    Script: {script}
    Output JSON only: [{{"script": "...", "prompt": "Cinematic horror shot description..."}}]
    """
    
    try:
        response = model.generate_content(prompt)
        text = response.text.replace('```json', '').replace('```', '').strip()
        return json.loads(text)
    except Exception as e:
        st.error(f"æ–‡æœ¬åˆ†æå¤±è´¥ ({model_name}): {e}")
        return None

def generate_image(prompt, key):
    genai.configure(api_key=key)
    try:
        # 2. å¼ºåˆ¶ä½¿ç”¨ä½ æˆªå›¾é‡Œçš„ Imagen 4
        # è¿™æ˜¯ä½ è´¦å·é‡Œç›®å‰æœ€å¼ºçš„ç”»å›¾æ¨¡å‹
        target_model = 'imagen-4.0-generate-001'
        
        model = genai.GenerativeModel(target_model)
        
        result = model.generate_images(
            prompt=prompt,
            number_of_images=1,
            aspect_ratio="16:9"
        )
        return result.images[0]._pil_image
    except Exception as e:
        # å¦‚æœ Imagen 4 å¤±è´¥ï¼Œå°è¯•é™çº§åˆ° Nano Banana (Gemini 3 Image)
        try:
            fallback = 'gemini-3-pro-image-preview'
            model = genai.GenerativeModel(fallback)
            result = model.generate_images(prompt=prompt, number_of_images=1)
            return result.images[0]._pil_image
        except:
            return f"Imagen 4 è°ƒç”¨å¤±è´¥: {e}"

# ================= ä¸»ç•Œé¢ =================
st.title("ğŸ§¬ MysteryNarrator (Powered by Imagen 4)")
st.caption("æ£€æµ‹åˆ°æ‚¨çš„è´¦å·æ‹¥æœ‰ Imagen 4 æƒé™ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢è‡³æœ€é«˜ç”»è´¨å¼•æ“ã€‚")

text_input = st.text_area("è¾“å…¥è§£è¯´è¯", height=100)

if st.button("ğŸš€ å¯åŠ¨æœªæ¥å¼•æ“"):
    if not api_key:
        st.error("è¯·å¡«å…¥ Key")
    else:
        with st.spinner("ğŸ¤– AI æ­£åœ¨è‡ªåŠ¨åŒ¹é…æ¨¡å‹..."):
            scenes = analyze_script(text_input, api_key)
            
        if scenes:
            st.success(f"åˆ†æå®Œæˆï¼å¼€å§‹ä½¿ç”¨ Imagen 4 æ¸²æŸ“...")
            
            result_container = st.container()
            
            for i, scene in enumerate(scenes):
                with result_container:
                    c1, c2 = st.columns([1, 2])
                    with c1:
                        st.markdown(f"**é•œå¤´ {i+1}**")
                        st.write(scene['script'])
                        st.caption(f"Prompt: {scene['prompt']}")
                    with c2:
                        img_res = generate_image(scene['prompt'], api_key)
                        if isinstance(img_res, str):
                            st.error("âŒ ç”»å›¾å¤±è´¥")
                            st.code(img_res)
                        else:
                            st.image(img_res, caption="Generated by Imagen 4")
                st.divider()
